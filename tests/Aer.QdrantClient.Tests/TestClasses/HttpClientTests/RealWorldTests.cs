using Aer.QdrantClient.Http;
using Aer.QdrantClient.Http.Models.Primitives;
using Aer.QdrantClient.Http.Models.Primitives.Vectors;
using Aer.QdrantClient.Http.Models.Requests.Public;
using Aer.QdrantClient.Http.Models.Shared;
using Aer.QdrantClient.Tests.Base;
using Aer.QdrantClient.Tests.Helpers;

namespace Aer.QdrantClient.Tests.TestClasses.HttpClientTests;

[Ignore("Real world tests are run locally only and are enabled manually")]
internal class RealWorldTests : QdrantTestsBase
{
    private QdrantHttpClient _qdrantHttpClient;

    [OneTimeSetUp]
    public void Setup()
    {
        //_qdrantHttpClient = new QdrantHttpClient(httpAddress: new Uri("xxxx"), apiKey: "xxxx");

        Initialize();
        _qdrantHttpClient = ServiceProvider.GetRequiredService<QdrantHttpClient>();
    }

    [SetUp]
    public async Task BeforeEachTest()
    {
        await ResetStorage(_qdrantHttpClient);
    }

    [Test]
    public async Task Insert_Sparse_PotentialDuplicates()
    {
        var sparseVectorsConfiguration = new Dictionary<string, SparseVectorConfiguration>()
        {
            [VectorBase.DefaultVectorName] = new()
            {
                Modifier = SparseVectorModifier.None,
                Index = new()
                {
                    OnDisk = true,
                    FullScanThreshold = 5000,
                    Datatype = VectorDataType.Float32
                }
            }
        };

        var collectionCreationResult = await _qdrantHttpClient.CreateCollection(
            TestCollectionName,
            new CreateCollectionRequest(sparseVectorsConfiguration: sparseVectorsConfiguration)
            {
                OnDiskPayload = true
            },
            CancellationToken.None);

        collectionCreationResult.EnsureSuccess();

        // Test points
        // The strange conversion to double and then to float via extension is here
        // to allow creating test points by simply copying JSON arrays
        List<(uint[] Indices, float[] Values)> pointsToUpsert = new(30) {
            (
            [
                    42063492,
                    6989584,
                    20368002,
                    3756617,
                    4581145,
                    9419763,
                    35440521,
                    33019296,
                    4215132,
                    38031927,
                    20804419,
                    9977510,
                    30224436,
                    6543284,
                    31514318,
                    42909699,
                    15221963,
                    44118979,
                    6317705,
                    21904869,
                    23335657,
                    3828637
                ]
                ,
                ((double[])
                [
                    0.31423953,
                    6.5268593,
                    6.52452,
                    6.5076027,
                    36.25371,
                    0.3142154,
                    0.25706837,
                    0.3141951,
                    6.5266047,
                    6.506746,
                    0.25705802,
                    0.3142112,
                    6.523748,
                    6.525363,
                    6.526891,
                    6.527066,
                    0.4114809,
                    6.2461777,
                    6.5241456,
                    0.4114157,
                    6.5260477,
                    6.526286
                ]
                ).ToFloat()
            ),
            (
            [
                    7139527,
                    39647129,
                    30470738,
                    31439363,
                    2839322,
                    7689455,
                    26214383,
                    34210435,
                    31335315,
                    15896350,
                    30606870,
                    8261923,
                    7377990,
                    24793652,
                    7174638,
                    693412,
                    46207473,
                    15685498,
                    44795042,
                    27473559,
                    42745348,
                    24014935,
                    16674878,
                    30763687,
                    21133126,
                    24917270,
                    24932855,
                    32661445,
                    24836644,
                    8790302,
                    1561148,
                    44520331,
                    10024844,
                    18586139,
                    20657324,
                    73522,
                    1334964,
                    33235200,
                    43010570,
                    33750055,
                    32910885,
                    9089180,
                    43605600,
                    11513532,
                    44442928,
                    5501029,
                    37039776,
                    27974603,
                    28401140,
                    41482663,
                    40685506,
                    23852659,
                    42371231,
                    43920028,
                    33011121,
                    35159727,
                    40697756,
                    38363984,
                    16623144,
                    11162182,
                    23363061,
                    24297325,
                    45628410,
                    31972525,
                    15196056,
                    16888654,
                    23272146,
                    46172294,
                    4769950,
                    39336937,
                    23968585,
                    11895273,
                    31390675,
                    40264204,
                    27479309,
                    9871681,
                    40045375
                ]
                ,
                ((double[])
                [
                    333.5582,
                    3.1439514,
                    150.82071,
                    289.60898,
                    19.169619,
                    77.160324,
                    76.91428,
                    190.84886,
                    19.831228,
                    19.199516,
                    147.09607,
                    306.2173,
                    3.14097,
                    617.3312,
                    313.1402,
                    7.554306,
                    67.395645,
                    69.72167,
                    65.08041,
                    327.59296,
                    0.099585526,
                    132.08713,
                    79.3134,
                    2.2912111,
                    75.95492,
                    138.4306,
                    6.214593,
                    79.35017,
                    39.132767,
                    9.258059,
                    18.969978,
                    468.8446,
                    18.38919,
                    166.84169,
                    365.87286,
                    276.87366,
                    172.17387,
                    11.656501,
                    18.38937,
                    328.40164,
                    17.600672,
                    266.06256,
                    149.89256,
                    345.631,
                    49.137764,
                    344.67172,
                    355.21487,
                    2.2912111,
                    340.4197,
                    81.46992,
                    82.165726,
                    70.577065,
                    143.55734,
                    288.79178,
                    71.77347,
                    79.34523,
                    79.35819,
                    382.01752,
                    1.4032441,
                    77.02964,
                    17.599127,
                    31.305902,
                    141.50616,
                    140.23538,
                    313.7717,
                    2696.3945,
                    8.8431835,
                    128.86264,
                    259.78,
                    53.656372,
                    51.2718,
                    0.6822267,
                    340.65985,
                    31.304604,
                    143.55734,
                    381.97235,
                    72.62009
                ]
                ).ToFloat()
            ),
            (
            [
                    3914366,
                    4162009,
                    32343112
                ]
                ,
                ((double[])
                [
                    9.330942,
                    8.706991,
                    8.942207
                ]
                ).ToFloat()
            ),
            (
            [
                    39316133,
                    23496607,
                    19122297,
                    14054796,
                    12441219,
                    30227727,
                    20363484,
                    10126228,
                    11185103,
                    39146270,
                    16843280,
                    21026379,
                    22182271,
                    26457221,
                    18119663
                ]
                ,
                ((double[])
                [
                    1.3989166,
                    369.42606,
                    91.69666,
                    122.79681,
                    401.47714,
                    0.9822618,
                    22.916542,
                    358.78424,
                    23.869131,
                    380.789,
                    417.05328,
                    387.2684,
                    22.267324,
                    485.69733,
                    22.884956
                ]
                ).ToFloat()
            ),
            (
            [
                    11977694,
                    1212103,
                    18288081,
                    36277581,
                    35589662,
                    29433096,
                    29897071,
                    24948320,
                    38285514,
                    33633619,
                    4502324,
                    18095619,
                    41941297,
                    25675663,
                    15162802,
                    38332435,
                    34343291,
                    36814073,
                    32553944,
                    45872601,
                    4424060,
                    10780906,
                    26766445,
                    41675155,
                    5847087,
                    38339113,
                    43307093,
                    39198449,
                    947769,
                    14280122,
                    6610336,
                    3369249,
                    40349522,
                    2612170,
                    12495217,
                    18921771,
                    24397190,
                    32457653,
                    17530907,
                    9743972,
                    20332774,
                    8330199,
                    12094512,
                    38083780,
                    38103872,
                    23837741,
                    15712876,
                    14411526,
                    21341061,
                    14498175,
                    22885725,
                    35552735,
                    27794010,
                    41158753,
                    27893492,
                    28170579,
                    26447457,
                    14390168
                ]
                ,
                ((double[])
                [
                    72.89189,
                    23.554386,
                    180.83977,
                    243.44943,
                    6.460816,
                    294.93533,
                    20.058403,
                    186.24257,
                    264.85632,
                    282.96243,
                    143.65097,
                    235.05862,
                    291.88092,
                    241.22586,
                    5.563536,
                    180.84792,
                    1.6423088,
                    17.968863,
                    180.83557,
                    56.09959,
                    295.53375,
                    26.176104,
                    357.65784,
                    0.56817347,
                    162.7278,
                    276.0525,
                    241.10606,
                    304.9537,
                    305.03665,
                    2239.3318,
                    373.45367,
                    80.536835,
                    393.7234,
                    66.94622,
                    40.46908,
                    240.91408,
                    1.6423289,
                    129.68834,
                    186.23643,
                    302.90604,
                    86.18693,
                    261.48788,
                    1.6422807,
                    71.325035,
                    331.36108,
                    313.09454,
                    0.3689121,
                    4.5923533,
                    171.07245,
                    161.35086,
                    1.4774147,
                    64.338455,
                    79.6123,
                    16.230507,
                    290.4652,
                    45.746094,
                    170.47833,
                    11.654671
                ]
                ).ToFloat()
            ),
            (
            [
                    32803371,
                    3443693,
                    38753558,
                    25203624,
                    12133759,
                    2747361,
                    8803227,
                    36651165,
                    16451768,
                    35184120,
                    17547740,
                    9948156,
                    42459108,
                    25936254,
                    1782590,
                    29999472,
                    9507425,
                    30785211
                ]
                ,
                ((double[])
                [
                    17.552067,
                    0.04055551,
                    50.761425,
                    18.266548,
                    50.673664,
                    11.657493,
                    99.05822,
                    94.93725,
                    94.96411,
                    18.306509,
                    11.659084,
                    18.284355,
                    18.269333,
                    1.8244029,
                    50.931007,
                    18.284935,
                    1.4617773,
                    11.65492
                ]
                ).ToFloat()
            ),
            (
            [
                    39007687,
                    40242733,
                    26173859,
                    27336504,
                    19197440,
                    12477158,
                    20486806,
                    7275717,
                    19164307,
                    11146189,
                    33864298,
                    43650743,
                    12384929,
                    6682972,
                    42907576,
                    40785793,
                    38145933,
                    43181752,
                    45815549,
                    29151956,
                    23918619,
                    14617408,
                    42872306,
                    38107733,
                    19119962,
                    20079109,
                    28606130,
                    25545721,
                    46449854,
                    30587783,
                    25213498
                ]
                ,
                ((double[])
                [
                    345.64218,
                    0.3839485,
                    5.376494,
                    623.84546,
                    395.21222,
                    338.73004,
                    8.714858,
                    407.90485,
                    9.339828,
                    279.68338,
                    349.46237,
                    69.93905,
                    49.943356,
                    1555.609,
                    318.6844,
                    289.2226,
                    7.7272453,
                    49.950665,
                    367.7486,
                    376.66983,
                    8.067178,
                    17.995344,
                    299.7707,
                    693.96356,
                    5.8995624,
                    60.199432,
                    442.84314,
                    49.940186,
                    388.2187,
                    0.94661933,
                    395.352
                ]
                ).ToFloat()
            ),
            (
            [
                    13511830,
                    3499581,
                    18400579
                ]
                ,
                ((double[])
                [
                    2.6551425,
                    26.954473,
                    0.095525995
                ]
                ).ToFloat()
            ),
            (
            [
                    25756549
                ]
                ,
                ((double[])
                [
                    0.67751306
                ]
                ).ToFloat()
            ),
            (
            [
                    26760140,
                    11163544,
                    36201645,
                    23190751,
                    23598373,
                    33701119,
                    30982608,
                    36297188,
                    15980845,
                    29524019,
                    16430691,
                    36813088,
                    31075791,
                    20739416,
                    34294044,
                    27997597,
                    40791271,
                    20682639,
                    45122790,
                    13761074,
                    31006643,
                    25941521,
                    36625385,
                    11659103,
                    43820189,
                    17195455,
                    37546280,
                    25085310,
                    11322110,
                    2931465,
                    4299384,
                    23522844,
                    38232096,
                    39280599,
                    35340639,
                    38345687,
                    44131336,
                    32746685,
                    31237495,
                    15392664,
                    2551053,
                    13763039,
                    34513444,
                    38116918,
                    42342719,
                    21097614,
                    17229783,
                    40848846,
                    6175162,
                    4427724,
                    14913484,
                    23314413,
                    1529634,
                    14509290,
                    8554738,
                    17118791,
                    30046611,
                    3558603,
                    6446869,
                    4995513,
                    20496717,
                    34341781,
                    38916825,
                    26889333,
                    41326641,
                    8749901,
                    557921,
                    8902020,
                    4390470,
                    5836099,
                    31842480,
                    17529542,
                    25610649
                ]
                ,
                ((double[])
                [
                    275.58063,
                    346.79297,
                    417.74316,
                    446.66772,
                    364.46344,
                    280.34058,
                    89.40716,
                    415.73907,
                    397.00925,
                    367.9263,
                    45.517284,
                    488.09485,
                    451.6264,
                    359.81256,
                    397.59784,
                    315.53577,
                    263.394,
                    377.9859,
                    314.64178,
                    446.56097,
                    354.45178,
                    403.02783,
                    257.5159,
                    368.9769,
                    340.3916,
                    467.12527,
                    488.08115,
                    115.20321,
                    422.43454,
                    230.35661,
                    257.7223,
                    353.14838,
                    114.20983,
                    235.96861,
                    407.42853,
                    358.15714,
                    398.94016,
                    411.9578,
                    420.34195,
                    391.66974,
                    3.5300398,
                    446.69113,
                    11.749623,
                    352.8367,
                    178.6158,
                    431.7365,
                    400.4737,
                    324.35577,
                    84.3153,
                    3.3190074,
                    332.15216,
                    387.83603,
                    107.49726,
                    92.79745,
                    416.6316,
                    152.1071,
                    168.66887,
                    487.8842,
                    325.0526,
                    256.27597,
                    423.07175,
                    232.92596,
                    417.61838,
                    351.76578,
                    354.70428,
                    4.7726383,
                    164.30484,
                    431.19937,
                    324.8247,
                    488.0383,
                    170.48936,
                    341.65445,
                    968.6866
                ]
                ).ToFloat()
            ),
            (
            [
                    25347607,
                    9228759,
                    4080679,
                    23980512,
                    44504976,
                    32713551,
                    10118923,
                    14889456,
                    40296096,
                    22197803
                ]
                ,
                ((double[])
                [
                    13.826191,
                    13.241342,
                    0.2904447,
                    13.241664,
                    13.822246,
                    13.825618,
                    12.899492,
                    11.096131,
                    11.093304,
                    12.427028
                ]
                ).ToFloat()
            ),
            (
            [
                    23740259,
                    13382791,
                    5791493,
                    37680285,
                    32676664,
                    24476308,
                    37937426,
                    27438098,
                    7051663,
                    41921644,
                    6190801,
                    42894871,
                    24501682,
                    28345241,
                    13760064,
                    32391991,
                    11230911,
                    31272456,
                    45765942,
                    3325093,
                    5476511,
                    25988468,
                    2157285,
                    22334360,
                    32983499,
                    8889568,
                    27947598,
                    14674589,
                    24369900,
                    4803748,
                    35458670,
                    29111943,
                    27732211,
                    26501096,
                    26476216,
                    44691698,
                    21333819
                ]
                ,
                ((double[])
                [
                    94.181305,
                    295.32684,
                    124.95994,
                    418.46756,
                    309.669,
                    369.95682,
                    453.2292,
                    411.90863,
                    209.81213,
                    414.89532,
                    406.73984,
                    250.37436,
                    395.51804,
                    109.66265,
                    399.42645,
                    308.7896,
                    209.80959,
                    370.27457,
                    398.9236,
                    136.41048,
                    414.30127,
                    209.80215,
                    372.99594,
                    377.5762,
                    399.25113,
                    91.01201,
                    370.84378,
                    403.5975,
                    433.18558,
                    398.9747,
                    200.95862,
                    414.8134,
                    331.4719,
                    92.385895,
                    714.12726,
                    368.85413,
                    411.46744
                ]
                ).ToFloat()
            ),
            (
            [
                    7170870,
                    12157711,
                    2772390,
                    37081893,
                    44236310,
                    8229319,
                    14762877,
                    15513165,
                    8284060,
                    23325057,
                    5545237,
                    26416524,
                    38610317,
                    15603055,
                    2887422,
                    4579059,
                    20797630
                ]
                ,
                ((double[])
                [
                    1.6282849,
                    15.68055,
                    3.0801756,
                    32.95945,
                    1208.7327,
                    8.124911,
                    14.629813,
                    1.2587045,
                    89.52986,
                    11.762596,
                    806.744,
                    15.6056,
                    0.12571941,
                    1.5595795,
                    0.977622,
                    0.93641573,
                    5.981354
                ]
                ).ToFloat()
            ),
            (
            [
                    35243040,
                    6789070,
                    42412188,
                    35780189,
                    10251700,
                    2529743,
                    26587129,
                    40590266,
                    33997860,
                    18902832,
                    41250947,
                    3722219,
                    16321221,
                    43882601,
                    27402684,
                    28976739,
                    39933180,
                    11082254,
                    42827835,
                    46337669,
                    3992922,
                    33305978,
                    31463861,
                    44569234,
                    13747762,
                    21254881,
                    2058855,
                    6372772,
                    21697358,
                    2152687,
                    3073236,
                    7345883,
                    6098488,
                    31296301,
                    37777986,
                    2177001,
                    15210436,
                    21289396,
                    3368472,
                    34231140,
                    17783358,
                    36236225,
                    12265710,
                    17047440
                ]
                ,
                ((double[])
                [
                    135.49348,
                    237.46931,
                    259.38602,
                    259.39676,
                    259.4749,
                    323.79358,
                    244.62859,
                    149.99472,
                    153.80046,
                    355.0592,
                    244.5072,
                    156.91417,
                    234.26363,
                    244.46635,
                    156.92009,
                    259.41513,
                    234.18279,
                    227.89949,
                    146.12413,
                    234.18764,
                    150.06444,
                    259.46478,
                    244.23155,
                    244.35667,
                    259.48758,
                    168.38823,
                    244.49199,
                    259.39993,
                    138.14606,
                    244.37007,
                    259.4727,
                    244.38467,
                    144.10149,
                    259.40784,
                    131.75314,
                    244.28159,
                    197.64987,
                    244.3534,
                    156.64345,
                    233.97382,
                    244.59486,
                    259.5034,
                    248.54091,
                    259.49136
                ]
                ).ToFloat()
            ),
            (
            [
                    22970543,
                    382974,
                    30020157,
                    34466885,
                    19243494,
                    17069323,
                    32254146,
                    39694899,
                    16992143,
                    26790142,
                    37291105,
                    23670945,
                    18636636,
                    30441294,
                    44022371,
                    25887950,
                    36704996,
                    20608234,
                    13990573,
                    40653950,
                    13352433,
                    27974930,
                    42830650,
                    3790571,
                    11793718,
                    17707463,
                    35044334,
                    38453256
                ]
                ,
                ((double[])
                [
                    445.69333,
                    410.98032,
                    505.94165,
                    426.67627,
                    471.76743,
                    435.0604,
                    916.0177,
                    505.26773,
                    504.32776,
                    266.18698,
                    483.9273,
                    254.88466,
                    241.56163,
                    254.92755,
                    376.56412,
                    451.05157,
                    505.26465,
                    412.3031,
                    456.25403,
                    32.49135,
                    484.57452,
                    483.9828,
                    506.15085,
                    472.19162,
                    241.55457,
                    484.2821,
                    483.95505,
                    450.90088
                ]
                ).ToFloat()
            ),
            (
            [
                    33661327,
                    37386544
                ]
                ,
                ((double[])
                [
                    0.053184595,
                    3.2234805
                ]
                ).ToFloat()
            ),
            (
            [
                    45564171,
                    19559669,
                    19230961,
                    12731842,
                    5163845,
                    33119564,
                    20420741,
                    1313580,
                    20292745,
                    26826054,
                    44766523,
                    24586365,
                    5803861,
                    24651155,
                    35701972,
                    43101005,
                    41853015,
                    3960551,
                    24554819,
                    14166565,
                    39426830,
                    36413655,
                    31400599,
                    36959780,
                    12151648,
                    17753977,
                    7882971,
                    22002968,
                    43547789,
                    34930269,
                    28252572,
                    9355642,
                    22887974,
                    17850091,
                    12081555,
                    13955,
                    35435594,
                    38586618,
                    13634180,
                    29611585,
                    7225747,
                    9072225,
                    34342015,
                    10896747,
                    45475040,
                    6747867,
                    13697208,
                    25919586,
                    9715678,
                    11401984,
                    23475486,
                    33380360,
                    23966927,
                    14056763,
                    30620331,
                    33166545,
                    584490,
                    413826,
                    16433592,
                    38827320,
                    34601286,
                    9536866,
                    18661278,
                    27690385,
                    35899875,
                    27840881,
                    17582410,
                    6340923,
                    3842518,
                    21631799,
                    24328765,
                    45318408,
                    43421856,
                    3399418,
                    39893628,
                    27126497,
                    11552763,
                    33428020
                ]
                ,
                ((double[])
                [
                    266.288,
                    11.181632,
                    102.081985,
                    452.29355,
                    311.1386,
                    11.544045,
                    1.8138138,
                    90.28426,
                    100.68043,
                    290.84766,
                    52.725346,
                    20.65431,
                    5.3804483,
                    37.860546,
                    61.350853,
                    69.73106,
                    12.670819,
                    9.914063,
                    180.18117,
                    1.1906399,
                    215.08173,
                    2.5068088,
                    25.256994,
                    4.9781756,
                    53.458096,
                    12.051356,
                    259.17426,
                    116.0365,
                    63.78533,
                    251.59528,
                    86.1501,
                    10.711809,
                    10.350955,
                    112.370926,
                    229.27637,
                    75.58119,
                    83.92834,
                    9.953422,
                    193.70999,
                    185.51694,
                    280.68655,
                    9.126758,
                    2658.209,
                    12.050489,
                    182.74307,
                    360.32495,
                    86.680374,
                    21.8721,
                    382.1901,
                    85.04839,
                    12.049255,
                    98.298134,
                    264.3311,
                    673.0321,
                    450.03867,
                    47.361183,
                    193.69604,
                    345.1429,
                    121.95285,
                    12.91869,
                    15.12232,
                    11.18001,
                    14.835779,
                    220.79478,
                    5.19155,
                    53.448254,
                    15.636027,
                    274.50406,
                    11.1835,
                    92.91723,
                    92.916435,
                    15.634655,
                    293.66397,
                    16.197725,
                    264.11627,
                    353.71463,
                    16.763283,
                    57.03246
                ]
                ).ToFloat()
            ),
            (
                [
                    19855532,
                    16538104
                ],
                ((double[])
                [
                    60.311134,
                    509.62155
                ]
                ).ToFloat()
            ),
            (
            [
                    30505956,
                    12426268,
                    35721,
                    10407486,
                    3532328,
                    39172264,
                    12385365,
                    12592004,
                    4237317,
                    43436674,
                    34199309,
                    11186753,
                    27432553,
                    30124888,
                    13814126,
                    42286239,
                    11563717,
                    23408142,
                    24296,
                    7083786,
                    23828073,
                    22856835,
                    42775406,
                    13829465,
                    34643590,
                    11541026,
                    41996417,
                    2082856,
                    46267181,
                    6259376,
                    17334550,
                    42629188,
                    3750660,
                    5436882,
                    17815519,
                    21053840,
                    37050309,
                    35900422,
                    6285402,
                    25608716
                ]
                ,
                ((double[])
                [
                    18.976154,
                    8.568605,
                    183.9034,
                    1.7019272,
                    313.40576,
                    8.568386,
                    8.204181,
                    255.23402,
                    8.2062025,
                    2746.0535,
                    29.222221,
                    330.34326,
                    1.7019085,
                    301.501,
                    311.10266,
                    7.7986937,
                    254.29265,
                    21.438078,
                    313.42334,
                    425.06622,
                    56.89083,
                    13.426136,
                    383.41193,
                    29.225855,
                    1.3058993,
                    1.701672,
                    215.82335,
                    666.64703,
                    182.7173,
                    8.206192,
                    32.943665,
                    526.5408,
                    258.887,
                    347.1044,
                    246.7399,
                    168.3621,
                    395.26236,
                    23.101645,
                    680.1702,
                    224.00323
                ]
                ).ToFloat()
            ),
            (
            [
                    13623346,
                    18305641,
                    3926943,
                    24035521,
                    11158141,
                    26417206,
                    44186121
                ]
                ,
                ((double[])
                [
                    123.39307,
                    390.89548,
                    364.78906,
                    323.23532,
                    343.82,
                    377.15738,
                    361.0457
                ]
                ).ToFloat()
            ),
            
            //( // Template

            //    ,
            //    ((double[])

            //    ).ToFloat()
            //),
        };

        List<UpsertPointsRequest.UpsertPoint> upsertPoints = new(pointsToUpsert.Capacity);

        int pointId = 0;

        foreach (var point in pointsToUpsert)
        {
            upsertPoints.Add(
                new(
                    id: pointId++,
                    vector: new NamedVectors()
                    {
                        Vectors = new Dictionary<string, VectorBase>()
                        {
                            [VectorBase.DefaultVectorName] = point,
                        }
                    },
                    // We deliberately assign large payload
                    payload: """
                    {
                        "type": [
                            "choice",
                            "affiliate_hot"
                        ],
                        "version": "20260202",
                        "camp_ids": [
                            2760,
                            2742,
                            2754
                        ],
                        "segment_ids": [
                            "24386",
                            "23991",
                            "15633",
                            "24573"
                        ],
                        "ship_to_list": [
                            "AZ",
                            "KG",
                            "RU",
                            "BY",
                            "UZ",
                            "MD",
                            "KZ",
                            "TJ",
                            "GE",
                            "AM",
                            "TM"
                        ],
                        "brand_value_id": -1,
                        "local_cate_ids": [
                            16008,
                            12,
                            50,
                            911
                        ],
                        "seller_admin_seq": 6002445992,
                        "source_id_item_id": "0_1005010328150973",
                        "mean_sku_item_price_rub": 121.46
                    }
                    """
                )
            );
        }

        var upsertPointsResult
           = await _qdrantHttpClient.UpsertPoints(
               TestCollectionName,
               new UpsertPointsRequest()
               {
                   Points = upsertPoints
               },
               CancellationToken.None);

        upsertPointsResult.Status.IsSuccess.Should().BeTrue();
    }

    //[Test]

    public async Task Insert_PotentialDuplicates()
    {
        double[] vectorValues =
        [
            0.8787277, -0.12667769, -0.7186715, 0.34238216, 0.6529496, 0.9607358, -1.3407203, -0.05516983, -1.7969699, -0.7624036,
            0.65227294, 1.7223959, 0.09729745, -2.4250467, -0.08025115, 0.5078333, 0.54697776, -0.033634894, 0.15833203,
            0.21261647, -0.32772928, -1.6786869, 1.8116331, -1.1187942, -0.18101482, 0.8181769, 0.9910732, -0.9036228, 0.52683735,
            0.60595685, 0.26787117, 0.92041886, 0.07284273, 0.2019225, 0.03758349, 0.42735377, -1.1501304, -0.33530962,
            -0.39584225, 0.3444461, 0.30743706, 0.20174314, -0.6723415, -0.81343776, 0.22216296, 0.9629104, 0.49917975, 0.1253293,
            1.7895324, -0.5767184, -0.24828121, -0.37844908, 0.5543383, -0.28737727, -0.77188087, 0.8510002, 0.012442401,
            1.5333815, -0.1764392, 0.53742635, 1.0552515, 0.6427478, -1.2882686, 0.5319315, -0.34650293, 0.49427897, -1.4467622,
            -0.5469479, 0.57641643, -0.2019957, -0.04420572, 1.1196884, -2.2209835, 1.6788898, 2.0373118, -1.0778058,
            -0.009934462, -0.4139702, -0.69643164, 0.25623098, 0.32013777, -1.4178662, 1.453767, -1.2854156, -0.4249559,
            -0.30052775, 0.17239584, -0.50819284, -0.16630816, 1.0546737, 0.61845076, 0.24718234, 2.4906254, -0.015319358,
            -0.9086923, 0.4294072, -0.99935985, -0.76197976, 0.7935137, -0.6133997, -0.22259578, 0.86507255, -0.09916944,
            0.37028685, 0.80937463, -0.6712452, 1.1897688, 0.49789405, -0.33125377, 0.55039316, -1.354061, 0.8627084, -0.9022874,
            -0.93917066, -0.16807975, -1.1731709, -0.7422827, -0.06411026, 0.55880874, -0.26387215, 0.36252126, 0.5204782,
            0.7125336, 0.27464563, 1.1216135, 1.2514266, 0.13544944, -1.5647521, 0.18598576, -1.2527033, 0.99144787, 0.34679794,
            -0.2697392, 1.0366445, 1.3917675, -1.2708815, 0.024458002, 1.8469185, -0.689326, -0.033687282, -0.80873257,
            -0.71935505, -0.6340056, 1.0534958, 0.72728986, -0.5091157, 1.1847786, 0.2579973, -0.7781229, 1.1513027, -0.3197454,
            -0.09275967, -1.517871, 0.6641441, 0.9902656, -0.6616016, -0.11708812, 0.3848811, -0.7450218, -0.15346283,
            -0.12680641, 0.84451014, -0.22541003, 0.5130689, 1.5078639, -0.6375235, -0.84930354, -0.08352368, 0.7430522,
            0.7071425, 0.8862804, 0.17265064, -0.4824108, -0.28339827, 0.8509444, -0.17535354, -0.72051644, 0.76037323,
            -1.1822718, -0.7893503, 0.21765956, -1.7401054, 0.4807144, -0.31567746, -0.59089583, -0.31763244, -0.94468486,
            0.94246274, -0.39586225, 0.89199513, 0.594007, 0.9916114, -0.53250146, 1.0358723, -0.24703725, 0.084327, 0.3515454,
            -1.5411878, -0.72129846, -0.5929884, 0.12395483, -0.12162623, 0.5648287, 0.48899993, 1.7190678, 0.48719347,
            0.39768988, -1.4440762, -0.1956659, -0.16685535, 0.79280394, 0.59123456, 0.05968815, -0.5370751, 0.3405953,
            0.037846852, -0.54680467, -1.0382084, 0.10517099, 0.059624612, 0.2955938, -0.6123637, -0.98756886, 0.9852787,
            0.1581021, 0.9339213, 0.49789104, -0.4312542, -0.031734288, 0.30151346, 0.03686244, -1.1644927, -0.82578963,
            -0.06669572, -0.1854245, 0.8741835, 0.494995, 0.7991263, 0.24562435, -0.07677714, -0.6491161, -0.56996995, -1.2649933,
            -1.4961032, -0.4751646, 1.732204, -0.555802, -0.23781323, -1.1293327, 1.320839, 0.09036978, -0.94374526, 1.322917,
            -1.3895092, 0.19756766, -0.13919646, 0.47781587, -0.20061557, 0.67796314, -0.31007573, 0.43472952, -1.0065655,
            0.5434207, -0.046010192, -0.25432864, -0.6564347, -0.006997475, 0.31825593, -0.041912682, 0.6208696, -0.48142615,
            0.5215936, 0.75489926, 0.47194797, -1.1523833, -0.5080032, 0.866584, -0.6534219, 0.3504536, 1.0557897, 0.26673266,
            -0.01611403, -0.9472906, 0.22016095, 1.1266252, 0.412308, -0.35885072, 1.0847564, -0.28795362, -0.81483984,
            -0.08677676, -0.46779558, 0.24048287, 1.7833129, 0.070527196, -0.67235833, 0.24987414, 1.7617239, -0.64356244,
            -0.97504437, -0.24353482, 0.12571855, 1.3705792, -0.73937654, 1.1452163, -0.152253, -0.8273829, 0.90302277, 1.1564949,
            0.7504338, 0.3096949, -1.0588862, -0.4860868, 0.24086839, 0.050243527, -0.4784744, 1.0043734, 0.37202817, 0.4627104,
            -0.103317946, -0.122625, 0.25616556, 0.41967472, -0.19348906, 0.19735594, -0.15588602, 0.047392175, 0.25112972,
            2.953613, -0.29593137, -0.5552204, 0.5595832, -1.3755706E-4, 0.12248584, 0.14107664, 0.9309887, 0.18906182,
            0.31736723, 0.28343913, -0.80899143, -0.64428014, 0.79907346, 0.41659647, 0.84765303, 0.20792724, 0.61453986,
            -0.61848086, 2.055193, -1.0874099, -0.5214486, 1.0196381, 0.013860736, 1.2782339, -0.023881333, -0.02746086,
            -0.06130017, 0.8312153, -1.3321444, 1.2861744, 1.2306224, 0.4554941, -0.20363781, -0.8932166, -0.17654727, 1.1325674,
            -0.0062872786, -0.22994441, 0.37878484, -0.46191177, -0.2876548, -0.4517125, 1.1765171, -0.43365413, -0.12537464,
            1.5034276, -0.40545377, 0.9174505, -1.1173459, -1.6503786, -0.10015173, -0.90019226, -0.68255574, -0.18115757,
            0.7231627, -0.21559593, -1.8912551, -0.71634316, -0.4794962, 0.5201837, 0.47890627, -1.2738028, 0.7875262, -0.7323423,
            0.5981152, -1.5194628, -0.68206453, 0.55715734, -0.71382266, -0.25260982, -1.3942575, -0.062177967, 0.2570095,
            -1.1972195, 0.8392429, 0.32122442, -1.4879935, -0.074141435, -0.51811934, 0.6083805, -0.4347049, -0.28747907,
            -0.53847784, 0.34835902, 0.35684016, -1.9651749, -0.30336195, 0.33380833, 0.8355069, 0.69799054, -0.81458056,
            -1.08207E-4, -0.88231516, 0.42223445, -0.22387332, -0.25584438, -1.2549261, 0.19197018, 1.0597714, -0.05390944,
            -0.8712299, 0.11868691, -0.39711228, -0.42881098, -0.36508253, -0.2043958, 1.1044091, -0.4887433, 0.98630166,
            -0.27948484, -1.3371253, 1.0713089, 0.8232338, -1.5204235, -0.14225918, 0.0061889407, 0.80432254, -1.060877,
            -2.3563209, 0.45460993, -0.78842765, 1.8508009, 1.1128857, -0.90657085, -1.6021861, -0.018929005, -0.05374071,
            0.7287444, -0.27699175, 0.4336507, -0.55254626, -0.5399616, 1.050981, 0.8805241, -0.5352121, -0.8254075, 0.73965216,
            -0.36950216, 0.27920407, 0.975007, 0.70045465, -0.75595695, -0.20699213, -0.01561932, 0.17289829, 1.8555359, 0.987874,
            -0.24096327, -0.65981513, 3.2516613, -0.5791811, 0.4024555, -2.0862217, -0.05749172, -1.076627, -0.25568238,
            -1.0165868, 0.1722168, -1.5710533, 0.5874765, -0.87118876, -0.69088703, 0.22106896, -0.5536876, -1.1332498,
            -0.7522742, 0.9495158, 0.8730732, 0.49048796, 1.0684347, 0.72184396, 0.13845037, -1.5253767, -0.18179461, -0.1182861,
            0.49265796, 0.108968474, 1.1427176, 1.019475, 0.07403621, -0.4736319, -0.1721225, -0.6582855, 0.08298, 0.12150421,
            -1.1602398, 0.069540955, 0.4169343, 1.1188469, -0.6559852, -1.9269425, -0.9092291, 0.09539858, 0.33531758, 0.14254138,
            -0.06950257, -0.6670472, 0.11221711, -0.61708814, 0.14753844, -0.36115593, -0.47757024, 0.24025008, 0.48828104,
            0.5329228, -1.3107795, -0.9958538, -0.29743877, -0.23368645, 0.38540167, -1.7322296, 0.28053617, -0.20590323,
            -0.94827336, -1.0346721, -2.2133863, 0.2952047, -0.40132624, -0.73111236, 0.8975786, -0.30890113, 0.41210577,
            0.61022145, -0.69348776, 0.0472737, -0.6242427, 1.2014728, -0.045957994, 0.3784231, 0.4986334, 1.3898466, 0.09845215,
            1.0892072, 1.0990702, -0.33229685, -0.82345635, 0.62852186, 0.114481926, -0.3608969, 0.6493167, -0.4552299,
            0.12743402, 0.88344306, -1.3145031, -0.66918176, -1.2367066, 0.108011596
        ];

        var vector = vectorValues.Select(v => (float)v).ToArray();

        var payload = new
        {
            cate_local_lv6_id = 7788,
            source_id_item_id = "0_1005007053586082"
        };

        (await _qdrantHttpClient.CreateCollection(
            TestCollectionName,
            new CreateCollectionRequest(VectorDistanceMetric.Cosine, vectorSize: 576, isServeVectorsFromDisk: true),
            CancellationToken.None)).EnsureSuccess();

        (await _qdrantHttpClient.UpsertPoints(
            TestCollectionName,
            new UpsertPointsRequest()
            {
                Points =
                [
                    new UpsertPointsRequest.UpsertPoint(PointId.NewGuid(), vector, payload)
                ]
            },
            CancellationToken.None)).EnsureSuccess();

        await _qdrantHttpClient.EnsureCollectionReady(TestCollectionName, CancellationToken.None);

        var collectionInfo = (await _qdrantHttpClient.GetCollectionInfo(
            TestCollectionName,
            isCountExactPointsNumber: true,
            CancellationToken.None)).EnsureSuccess();

        collectionInfo.PointsCount.Should().Be(1);

        var pointsReadBack = (await _qdrantHttpClient.SearchPoints(
            TestCollectionName,
            new SearchPointsRequest(vector, limit: 10, withVector: true, withPayload: true),
            CancellationToken.None)).EnsureSuccess();

        pointsReadBack.Length.Should().Be(1);
    }

    //[Test]
    public async Task Search()
    {
        double[] vectorRaw =
        [
            0.06732, -0.053447, 0.018991, 0.091428, 0.065955, -0.083695, -0.001819, -0.025018, -0.034342, 0.064136, -0.060952,
            -0.036844, -0.045032, 0.083695, -0.097796, -0.037754, 0.097341, -0.060042, -0.075507, 0.038891, -0.02479, -0.064136,
            0.090973, -0.016375, 0.008358, 0.093702, 0.080966, -0.04958, -0.083695, 0.094157, 0.015124, -0.043667, -0.006283,
            -0.069594, 0.094157, 0.039118, -0.039346, 0.000174, 0.06732, 0.025472, -0.022061, -0.068685, 0.075507, -0.00021,
            0.015807, -0.023994, 0.008415, -0.002004, 0.045259, -0.030931, -0.004236, 0.035934, -0.030248, -0.096886, -0.026041,
            -0.059132, -0.072778, -0.019218, 0.004094, -0.069594, -0.030476, 0.08415, 0.020014, -0.028315, -0.081876, 0.021833,
            -0.085969, -0.036162, 0.047761, 0.06732, -0.049808, -0.069139, 0.054584, 0.031158, -0.019559, 0.095067, -0.094157,
            -0.021265, 0.029566, 0.060497, -0.0655, -0.009893, -0.008472, -0.015579, 0.075053, 0.002303, 0.010064, -0.061407,
            0.095976, 0.037526, 0.024904, -0.080511, 0.02081, 0.06823, -0.071869, -0.070504, 0.056631, 0.00361, 0.00064, -0.039801
        ];

        var vector = vectorRaw.Select(v => (float)v).ToArray();

        var searchResult = await _qdrantHttpClient.SearchPoints(
            "test_collection_dim_100",
            new SearchPointsRequest(vector, 1)
            {
                WithVector = true,
                WithPayload = true,
            }
            ,
            CancellationToken.None);

        searchResult.Status.IsSuccess.Should().BeTrue();
    }
}
